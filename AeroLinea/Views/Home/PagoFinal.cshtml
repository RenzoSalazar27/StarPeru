@{
    ViewData["Title"] = "Confirmación de Pago";
}

<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-gradient-primary text-white">
            <h4 class="text-center mb-0">Confirmación de Pago</h4>
        </div>
        <div class="card-body p-4">
            <form asp-action="ProcesarPago" method="post" class="row g-3 needs-validation" novalidate>
                @Html.AntiForgeryToken()

                <!-- Método de pago -->
                <div class="col-md-6">
                    <label for="metodoPago" class="form-label">Método de Pago</label>
                    <select class="form-select" id="metodoPago" name="metodoPago" required>
                        <option selected disabled value="">Seleccione una opción</option>
                        <option value="tarjeta">Tarjeta de Crédito / Débito</option>
                        <option value="paypal">PayPal</option>
                    </select>
                    <div class="invalid-feedback">Seleccione un método de pago válido.</div>
                </div>

                <!-- Número de tarjeta -->
                <div class="col-md-6">
                    <label for="numeroTarjeta" class="form-label">Número de Tarjeta</label>
                    <input type="text" class="form-control" id="numeroTarjeta" name="numeroTarjeta" required pattern="^\d{16,19}$" maxlength="19" placeholder="Ej. 1234567812345678">
                    <div class="invalid-feedback">Ingrese un número válido (16 a 19 dígitos).</div>
                </div>

                <!-- Nombre de titular -->
                <div class="col-md-6">
                    <label for="nombreTarjeta" class="form-label">Nombre del Titular</label>
                    <input type="text" class="form-control" id="nombreTarjeta" name="nombreTarjeta" required minlength="5" maxlength="25" placeholder="Nombre completo">
                    <div class="invalid-feedback">Ingrese entre 5 y 25 caracteres.</div>
                </div>

                <!-- Fecha de expiración -->
                <div class="col-md-3">
                    <label for="fechaExpiracion" class="form-label">Fecha de Expiración</label>
                    <input type="month" class="form-control" id="fechaExpiracion" name="fechaExpiracion" required>
                    <div class="invalid-feedback">Seleccione una fecha válida.</div>
                </div>

                <!-- CVV -->
                <div class="col-md-3">
                    <label for="cvv" class="form-label">CVV / CVC</label>
                    <input type="text" class="form-control" id="cvv" name="cvv" required pattern="^\d{3,4}$" maxlength="4" placeholder="Ej. 123">
                    <div class="invalid-feedback">Debe tener 3 o 4 dígitos.</div>
                </div>

                <!-- Email -->
                <div class="col-md-6">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email" name="email" required value="@ViewBag.Email" placeholder="ejemplo@correo.com">
                    <div class="invalid-feedback">Ingrese un correo válido.</div>
                </div>

                <!-- Celular -->
                <div class="col-md-6">
                    <label for="celular" class="form-label">Número de Celular</label>
                    <input type="tel" class="form-control" id="celular" name="celular" required pattern="^\d{9}$" placeholder="9 dígitos">
                    <div class="invalid-feedback">Ingrese un número válido (9 dígitos).</div>
                </div>

                <!-- Banco -->
                <div class="col-md-6">
                    <label for="bancoTarjeta" class="form-label">Banco de la Tarjeta</label>
                    <select class="form-select" id="bancoTarjeta" required onchange="calcularDescuento()">
                        <option value="">Seleccione su banco</option>
                        <option value="OH">OH! (50% Descuento)</option>
                        <option value="BBVA">BBVA (25% Descuento)</option>
                        <option value="BCP">BCP (10% Descuento)</option>
                        <option value="otro">Otro (Sin descuento)</option>
                    </select>
                    <div class="invalid-feedback">Seleccione un banco.</div>
                </div>

                <!-- Tipo de comprobante -->
                <div class="col-md-6">
                    <label for="tipoDocumento" class="form-label">Tipo de Comprobante</label>
                    <select class="form-select" name="tipoDocumento" required>
                        <option value="">Seleccione</option>
                        <option value="boleta">Boleta</option>
                        <option value="factura">Factura</option>
                    </select>
                    <div class="invalid-feedback">Seleccione el tipo de comprobante.</div>
                </div>

                <!-- Precio original -->
                <div class="col-md-6">
                    <label class="form-label">Precio Base</label>
                    <input type="text" class="form-control" id="precioOriginal" value="500.00" readonly />
                </div>

                <!-- Precio con descuento -->
                <div class="col-md-6">
                    <label class="form-label">Precio con Descuento</label>
                    <input type="text" class="form-control" id="precioConDescuento" name="precioConDescuento" readonly />
                </div>

                <!-- Campo oculto para banco -->
                <input type="hidden" name="bancoTarjeta" id="bancoTarjetaHidden" />

                <!-- Check de términos -->
                <div class="col-12 mt-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="terminos" required>
                        <label class="form-check-label" for="terminos">
                            Acepto los <a href="#">términos y condiciones</a>.
                        </label>
                        <div class="invalid-feedback">Debe aceptar para continuar.</div>
                    </div>
                </div>

                <!-- Botón -->
                <div class="col-12 mt-4 text-center">
                    <button type="submit" class="btn btn-success btn-lg w-50">Confirmar y Pagar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cálculo de descuento por banco
        function calcularDescuento() {
            const banco = document.getElementById("bancoTarjeta").value;
            const precioBase = parseFloat(document.getElementById("precioOriginal").value);
            let descuento = 0;

            switch (banco) {
                case "OH":
                    descuento = 0.50;
                    break;
                case "BBVA":
                    descuento = 0.25;
                    break;
                case "BCP":
                    descuento = 0.10;
                    break;
                default:
                    descuento = 0;
            }

            const precioFinal = precioBase * (1 - descuento);
            document.getElementById("precioConDescuento").value = precioFinal.toFixed(2);
            document.getElementById("bancoTarjetaHidden").value = banco;
        }

        // Validación Bootstrap
        (() => {
            'use strict';
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();
    </script>
}