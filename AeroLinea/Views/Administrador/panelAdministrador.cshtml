@{
    Layout = null;
    var usuarios = ViewBag.Usuarios as List<AeroLinea.Models.Usuario>;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>
    <link rel="stylesheet" href="~/css/Administrador/panelAdministrador.css" /> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <script>
        // JavaScript para controlar el cambio de secciones
        function mostrarSeccion(seccion) {
            var secciones = document.querySelectorAll('.seccion');
            secciones.forEach(function(sec) {
                sec.style.display = 'none';
            });

            document.getElementById(seccion).style.display = 'block';
        }

        window.onload = function() {
            mostrarSeccion('usuarios');
        };

        let vueloId = 1;
        function agregarVuelo() {
            const ruta = document.getElementById('ruta').value;
            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('hora').value;

            if (ruta === "" || fecha === "" || hora === "") {
                alert("Por favor complete todos los campos.");
                return;
            }
            const nuevaFila = document.createElement('tr');
            const celdaId = document.createElement('td');
            celdaId.textContent = vueloId++;
            const celdaRuta = document.createElement('td');
            celdaRuta.textContent = ruta;
            const celdaFecha = document.createElement('td');
            celdaFecha.textContent = fecha;
            const celdaHora = document.createElement('td');
            celdaHora.textContent = hora;
            const celdaEstado = document.createElement('td');
            celdaEstado.textContent = 'Programado';
            nuevaFila.appendChild(celdaId);
            nuevaFila.appendChild(celdaRuta);
            nuevaFila.appendChild(celdaFecha);
            nuevaFila.appendChild(celdaHora);
            nuevaFila.appendChild(celdaEstado);

            document.getElementById('tabla-vuelos').querySelector('tbody').appendChild(nuevaFila)
            document.getElementById('ruta').value = "";
            document.getElementById('fecha').value = "";
            document.getElementById('hora').value = "";
            alert('Vuelo registrado con éxito!');          

        }

        function mostrarMensajeError(mensaje, elementoId) {
            const elemento = document.getElementById(elementoId);
            elemento.textContent = mensaje;
            elemento.style.display = 'block';
            setTimeout(() => {
                elemento.style.display = 'none';
            }, 5000);
        }

        function mostrarMensajeExito(mensaje) {
            const elemento = document.getElementById('mensajeExito');
            elemento.textContent = mensaje;
            elemento.style.display = 'block';
            setTimeout(() => {
                elemento.style.display = 'none';
            }, 5000);
        }

        function editarUsuario(id) {
            document.getElementById('errorEdicion').style.display = 'none';
            fetch('/Home/ObtenerUsuario/' + id)
                .then(response => response.json())
                .then(usuario => {
                    if (!usuario.success) {
                        mostrarMensajeError(usuario.message || 'Error al cargar usuario', 'errorEdicion');
                        return;
                    }
                    document.getElementById('editId').value = usuario.idUsuario;
                    document.getElementById('editNombres').value = usuario.nombresUsuario;
                    document.getElementById('editApellidos').value = usuario.apellidosUsuario;
                    document.getElementById('editNacimiento').value = usuario.nacimientoUsuario;
                    document.getElementById('editTelefono').value = usuario.telefonoUsuario;
                    document.getElementById('editIdentificacion').value = usuario.identificacionUsuario;
                    document.getElementById('editCorreo').value = usuario.correoUsuario;
                    document.getElementById('editDiscapacidad').value = usuario.discapacidad;
                    $('#modalEditar').modal('show');
                })
                .catch(error => {
                    mostrarMensajeError('Error al cargar usuario: ' + error.message, 'errorEdicion');
                });
        }

        function guardarEdicion() {
            const usuario = {
                idUsuario: document.getElementById('editId').value
            };

            // Solo agregar campos que no estén vacíos
            const nombres = document.getElementById('editNombres').value;
            const apellidos = document.getElementById('editApellidos').value;
            const nacimiento = document.getElementById('editNacimiento').value;
            const telefono = document.getElementById('editTelefono').value;
            const identificacion = document.getElementById('editIdentificacion').value;
            const correo = document.getElementById('editCorreo').value;
            const discapacidad = document.getElementById('editDiscapacidad').value;

            if (nombres) usuario.nombresUsuario = nombres;
            if (apellidos) usuario.apellidosUsuario = apellidos;
            if (nacimiento) usuario.nacimientoUsuario = nacimiento;
            if (telefono) usuario.telefonoUsuario = telefono;
            if (identificacion) usuario.identificacionUsuario = identificacion;
            if (correo) usuario.correoUsuario = correo;
            usuario.discapacidad = discapacidad === 'true';

            fetch('/Home/ActualizarUsuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(usuario)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#modalEditar').modal('hide');
                    mostrarMensajeExito(data.message);
                    location.reload();
                } else {
                    mostrarMensajeError(data.message || 'Error al actualizar usuario', 'errorEdicion');
                }
            })
            .catch(error => {
                mostrarMensajeError('Error al actualizar usuario: ' + error.message, 'errorEdicion');
            });
        }

        function cambiarRol(id, esAdmin) {
            document.getElementById('errorRol').style.display = 'none';
            document.getElementById('cambiarRolId').value = id;
            document.getElementById('cambiarRolActual').value = esAdmin;
            $('#modalCambiarRol').modal('show');
        }

        function confirmarCambioRol() {
            const id = document.getElementById('cambiarRolId').value;
            const esAdmin = document.getElementById('cambiarRolActual').value === 'true';

            fetch('/Home/CambiarRol', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                    esAdmin: !esAdmin
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#modalCambiarRol').modal('hide');
                    mostrarMensajeExito(data.message || 'Rol actualizado correctamente');
                    location.reload();
                } else {
                    mostrarMensajeError(data.message || 'Error al cambiar el rol', 'errorRol');
                }
            })
            .catch(error => {
                mostrarMensajeError('Error al cambiar rol: ' + error.message, 'errorRol');
            });
        }

        function eliminarUsuario(id) {
            document.getElementById('errorEliminar').style.display = 'none';
            document.getElementById('eliminarId').value = id;
            $('#modalEliminar').modal('show');
        }

        function confirmarEliminacion() {
            const id = document.getElementById('eliminarId').value;

            fetch('/Home/EliminarUsuario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#modalEliminar').modal('hide');
                    mostrarMensajeExito(data.message || 'Usuario eliminado correctamente');
                    location.reload();
                } else {
                    mostrarMensajeError(data.message || 'Error al eliminar usuario', 'errorEliminar');
                }
            })
            .catch(error => {
                mostrarMensajeError('Error al eliminar usuario: ' + error.message, 'errorEliminar');
            });
        }
    </script>
    
</head>
<body>
    <div class="admin-panel">
        <!-- Barra lateral -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="javascript:void(0);" onclick="mostrarSeccion('usuarios')">Usuarios</a></li>
                <li><a href="javascript:void(0);" onclick="mostrarSeccion('promociones')">Promociones</a></li>
                <li><a href="javascript:void(0);" onclick="mostrarSeccion('vuelos')">Vuelos Programados</a></li>
                <li><a href="javascript:void(0);" onclick="mostrarSeccion('registro-vuelo')">Registrar Vuelo</a></li>
                <li><a href="@Url.Action("Index", "Home")">Volver al Inicio</a></li>
            </ul>
        </nav>

        <!-- Contenido principal -->
        <div class="main-content">
            <div id="contenido">
                <!-- Sección Usuarios -->
                <section id="usuarios" class="seccion">
                    <h3>Usuarios Registrados</h3>
                    <div id="mensajeError" class="alert alert-danger" style="display: none;"></div>
                    <div id="mensajeExito" class="alert alert-success" style="display: none;"></div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Nombres</th>
                                    <th>Apellidos</th>
                                    <th>Nacimiento</th>
                                    <th>Teléfono</th>
                                    <th>Identificación</th>
                                    <th>Correo</th>
                                    <th>Contraseña</th>
                                    <th>Discapacidad</th>
                                    <th>Rol</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var usuario in usuarios)
                                {
                                    <tr>
                                        <td>@usuario.nombresUsuario</td>
                                        <td>@usuario.apellidosUsuario</td>
                                        <td>@usuario.nacimientoUsuario.ToShortDateString()</td>
                                        <td>@usuario.telefonoUsuario</td>
                                        <td>@usuario.identificacionUsuario</td>
                                        <td>@usuario.correoUsuario</td>
                                        <td>********</td>
                                        <td>@(usuario.discapacidad ? "Sí" : "No")</td>
                                        <td>@(usuario.esAdmin ? "Administrador" : "Pasajero")</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="editarUsuario(@usuario.idUsuario)">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="cambiarRol(@usuario.idUsuario, @usuario.esAdmin.ToString().ToLower())">
                                                <i class="fas fa-user-shield"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="eliminarUsuario(@usuario.idUsuario)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Sección Promociones -->
                <section id="promociones" class="seccion" style="display: none;">
                    <h3>Promociones Activas</h3>
                    <ul>
                        <!-- Datos dinámicos de promociones se mostrarán aquí -->
                    </ul>
                </section>

                <!-- Sección Vuelos -->
                <section id="vuelos" class="seccion" style="display: none;">
                    <h3>Vuelos Programados</h3>
                    <table class="table table-striped" id="tabla-vuelos">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Ruta</th>
                                <th>Fecha</th>
                                <th>Hora</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Aquí se agregarán los vuelos dinámicamente -->
                        </tbody>
                    </table>
                    <button type="button" class="btn btn-success">Registrar vuelo</button>
                    <button type="button" class="btn btn-danger">Eliminar vuelo</button>
                </section>

                <section id="registro-vuelo" class="seccion">
                    <h3>Registrar Nuevo Vuelo</h3>
                    <form onsubmit="event.preventDefault(); agregarVuelo();">
                        <label for="ruta">Ruta:</label>
                        <input type="text" id="ruta" name="ruta" required />

                        <label for="fecha">Fecha:</label>
                        <input type="date" id="fecha" name="fecha" required />

                        <label for="hora">Hora:</label>
                        <input type="time" id="hora" name="hora" required />

                        <button type="submit">Registrar Vuelo</button>
                    </form>

                    <p>Los vuelos registrados se mostrarán en la tabla de Vuelos Programados.</p>
                </section>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="modalEditar" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="errorEdicion" class="alert alert-danger" style="display: none;"></div>
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label>Nombres</label>
                        <input type="text" class="form-control" id="editNombres" required>
                    </div>
                    <div class="form-group">
                        <label>Apellidos</label>
                        <input type="text" class="form-control" id="editApellidos" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="editNacimiento" required>
                    </div>
                    <div class="form-group">
                        <label>Teléfono</label>
                        <input type="text" class="form-control" id="editTelefono" required>
                    </div>
                    <div class="form-group">
                        <label>Identificación</label>
                        <input type="text" class="form-control" id="editIdentificacion" required>
                    </div>
                    <div class="form-group">
                        <label>Correo</label>
                        <input type="email" class="form-control" id="editCorreo" required>
                    </div>
                    <div class="form-group">
                        <label>Discapacidad</label>
                        <select class="form-control" id="editDiscapacidad">
                            <option value="false">No</option>
                            <option value="true">Sí</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarEdicion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cambiar Rol -->
    <div class="modal fade" id="modalCambiarRol" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cambiar Rol de Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="errorRol" class="alert alert-danger" style="display: none;"></div>
                    <input type="hidden" id="cambiarRolId">
                    <input type="hidden" id="cambiarRolActual">
                    <p>¿Está seguro que desea cambiar el rol de este usuario?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="confirmarCambioRol()">Confirmar Cambio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Eliminar Usuario -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Eliminar Usuario</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="errorEliminar" class="alert alert-danger" style="display: none;"></div>
                    <input type="hidden" id="eliminarId">
                    <p>¿Está seguro que desea eliminar este usuario?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">Confirmar Eliminación</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
